<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'OpenShift Controller - –ì—Ä—É–ø–ø–∞ ' + ${group.name}">–ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 24px;
            color: #333;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 26px;
            font-weight: 500;
            color: #333;
            margin: 0 0 10px 0;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #0066cc;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 14px 18px;
            margin-bottom: 18px;
            font-size: 14px;
            border: 1px solid;
            border-radius: 4px;
        }

        .alert-success {
            background: #f0f9f0;
            color: #2d5016;
            border-color: #4caf50;
        }

        .alert-error {
            background: #fff5f5;
            color: #8b2635;
            border-color: #f44336;
        }

        .actions-bar {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 18px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 9px 18px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            color: white;
        }

        .btn:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #fb8c00;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background: #1e88e5;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .btn:disabled:hover {
            box-shadow: none;
            transform: none;
        }

        .group-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            padding-bottom: 20px;
        }

        /* –î–ª—è 1-2 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π - —É–¥–æ–±–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
        .group-container:has(.connection-column:only-child) {
            grid-template-columns: 1fr;
            max-width: 800px;
            margin: 0 auto;
        }

        .group-container:has(.connection-column:nth-child(2):last-child) {
            grid-template-columns: repeat(2, 1fr);
        }

        .connection-column {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .connection-column:nth-child(1) {
            border-left: 3px solid #2196f3;
        }

        .connection-column:nth-child(2) {
            border-left: 3px solid #4caf50;
        }

        .connection-header {
            border-bottom: 1px solid #ddd;
            padding-bottom: 14px;
            margin-bottom: 16px;
            padding: 14px;
            margin: -18px -18px 16px -18px;
            background: #f8f9fa;
        }

        .connection-header h2 {
            font-size: 17px;
            font-weight: 500;
            color: #333;
            margin: 0 0 8px 0;
        }

        .connection-info {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .connection-info div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .deployments-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .deployment-row {
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            padding: 10px 14px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 14px;
            margin: 0;
            transition: background 0.15s;
        }

        .deployment-row:first-child {
            border-top: 1px solid #e0e0e0;
            border-radius: 2px 2px 0 0;
        }

        .deployment-row:last-child {
            border-radius: 0 0 2px 2px;
        }

        .deployment-row:hover {
            background: #f8f8f8;
            border-color: #ccc;
        }

        .deployment-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            min-width: 160px;
            flex-shrink: 0;
        }

        .deployment-info {
            display: flex;
            gap: 14px;
            align-items: center;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }

        .deployment-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .deployment-info-label {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        .deployment-info-value {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .scale-form {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .scale-input-small {
            padding: 5px 9px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
            width: 52px;
            text-align: center;
        }

        .scale-input-small:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .btn-save {
            background: #2196f3;
            border: none;
            color: white;
            padding: 5px 14px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background: #1e88e5;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .deployment-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .btn-action {
            padding: 5px 11px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            color: white;
            transition: all 0.2s;
        }

        .btn-action:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .btn-restart {
            background: #ff9800;
            color: white;
        }

        .btn-restart:hover {
            background: #fb8c00;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #e53935;
        }

        .btn-restore {
            background: #4caf50;
            color: white;
        }

        .btn-restore:hover {
            background: #43a047;
        }

        .deployment-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
            min-width: 18px;
        }

        .batch-actions {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .batch-actions.hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .error-state {
            padding: 15px;
            background: #fed7d7;
            color: #742a2a;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        form {
            display: inline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–∞–º</a>
            <h1><span th:text="${group.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</span></h1>
            <div th:if="${group.description != null and !group.description.isEmpty()}" 
                 style="font-size: 13px; color: #666; margin-top: 8px;">
                <span th:text="${group.description}">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</span>
            </div>
        </div>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- –û–±—â–∞—è –ø–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö deployments –∏–∑ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π -->
        <div class="actions-bar" style="margin-bottom: 24px;">
            <span style="font-weight: 600; color: #333; margin-right: 12px;">–í—ã–±—Ä–∞–Ω–æ: <span id="globalSelectedCount">0</span></span>
            <form id="globalBatchShutdownForm" th:action="@{'/groups/' + ${group.id} + '/batch/shutdown'}" method="post" style="display: inline;">
                <input type="hidden" name="selectedDeployments" id="globalShutdownDeployments">
                <button type="submit" class="btn btn-danger" id="globalBatchShutdownBtn" disabled>
                    üõë –ü–æ—Ç—É—à–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </form>
            <form id="globalBatchRestartForm" th:action="@{'/groups/' + ${group.id} + '/batch/restart'}" method="post" style="display: inline;">
                <input type="hidden" name="selectedDeployments" id="globalRestartDeployments">
                <button type="submit" class="btn btn-warning" id="globalBatchRestartBtn" disabled>
                    üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </form>
            <form id="globalBatchRestoreForm" th:action="@{'/groups/' + ${group.id} + '/batch/restore'}" method="post" style="display: inline;">
                <input type="hidden" name="selectedDeployments" id="globalRestoreDeployments">
                <button type="submit" class="btn btn-success" id="globalBatchRestoreBtn" disabled>
                    ‚Ü©Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </form>
            <form th:action="@{'/groups/' + ${group.id} + '/update-original-state-all'}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-primary">üíæ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≤—Å–µ)</button>
            </form>
            <button type="button" class="btn btn-primary" onclick="saveAllScalingsInGroup()" style="background: #4caf50;" id="saveAllScalingsBtn" th:data-group-id="${group.id}" disabled>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
            </button>
        </div>

        <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã -->
        <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
            <input type="text" 
                   id="groupDeploymentSearch" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é deployment –≤–æ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö..." 
                   style="width: 100%; padding: 10px 16px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                   oninput="filterDeploymentsInGroup()">
        </div>

        <!-- –°—Ç–æ–ª–±—Ü—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π -->
        <div class="group-container" th:if="${connectionsWithDeployments != null and !connectionsWithDeployments.isEmpty()}">
            <div th:each="connWithDepl : ${connectionsWithDeployments}" class="connection-column">
                <div class="connection-header">
                    <h2>
                        <span th:text="${connWithDepl.connection.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
                        <span th:if="${connWithDepl.connection.isMock}" 
                              style="display: inline-block; padding: 2px 6px; border: 1px solid #999; color: #666; font-size: 10px; font-weight: 400; text-transform: uppercase; margin-left: 8px;">Mock</span>
                    </h2>
                    <div class="connection-info">
                        <div>
                            <strong>Namespace:</strong>
                            <span th:text="${connWithDepl.namespace}">namespace</span>
                        </div>
                        <div>
                            <strong>URL:</strong>
                            <span th:text="${connWithDepl.connection.masterUrl}">URL</span>
                        </div>
                        <div th:if="${connWithDepl.lastUpdateDate != null}" style="margin-top: 12px; font-size: 35px; font-weight: 600; color: #333; text-align: center; padding: 12px 0; background: #f8f9fa; border-radius: 4px; border: 1px solid #e0e0e0;">
                            –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π: 
                            <span style="color: #2196f3; font-weight: 700;" th:text="${#temporals.format(connWithDepl.lastUpdateDate, 'HH:mm:ss dd.MM.yyyy')}"></span>
                        </div>
                    </div>
                    <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
                    <div class="connection-actions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <form th:action="@{'/groups/' + ${group.id} + '/connections/' + ${connWithDepl.connection.id} + '/update-original-state'}" method="post">
                            <button type="submit" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">üíæ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</button>
                        </form>
                    </div>
                </div>

                <div th:if="${connWithDepl.error}" class="error-state" th:text="${connWithDepl.error}"></div>

                <div th:if="${connWithDepl.deployments != null and !connWithDepl.deployments.isEmpty()}">
                    <div class="deployments-list">
                        <div class="deployment-row" style="background: #fafafa; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; padding: 8px 14px;">
                            <div style="min-width: 18px;">
                                <input type="checkbox" th:id="'selectAll-' + ${connWithDepl.connection.id}" 
                                       class="deployment-checkbox" 
                                       th:onchange="'toggleSelectAllForConnection(' + ${connWithDepl.connection.id} + ')'" 
                                       title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤ —ç—Ç–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏">
                            </div>
                            <div class="deployment-name">–ò–º—è</div>
                            <div class="deployment-info" style="gap: 8px;">–¢–µ–∫—É—â–∏–µ / –°—Ç–∞—Ä—Ç–æ–≤–æ–µ / –ì–æ—Ç–æ–≤—ã–µ</div>
                            <div class="scale-form" style="min-width: 100px;">–ò–∑–º–µ–Ω–∏—Ç—å</div>
                            <div class="deployment-actions" style="min-width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</div>
                        </div>
                        <div th:each="deployment : ${connWithDepl.deployments}" class="deployment-row">
                            <div style="min-width: 18px;">
                                <input type="checkbox" 
                                       class="deployment-checkbox deployment-select" 
                                       th:value="${deployment.name}"
                                       th:data-connection-id="${connWithDepl.connection.id}"
                                       th:data-namespace="${connWithDepl.namespace}"
                                       onchange="updateGlobalBatchActions()">
                            </div>
                            <div class="deployment-name" th:text="${deployment.name}">Deployment Name</div>
                            <div class="deployment-info">
                                <div class="deployment-info-item">
                                    <span class="deployment-info-label">–¢–µ–∫—É—â–∏–µ:</span>
                                    <span class="deployment-info-value" th:text="${deployment.currentReplicas}">0</span>
                                </div>
                                <div class="deployment-info-item">
                                    <span class="deployment-info-label">–°—Ç–∞—Ä—Ç–æ–≤–æ–µ:</span>
                                    <span class="deployment-info-value" th:text="${deployment.originalReplicas ?: deployment.currentReplicas}">0</span>
                                </div>
                                <div class="deployment-info-item" th:if="${deployment.readyReplicas != null}">
                                    <span class="deployment-info-label">–ì–æ—Ç–æ–≤—ã–µ:</span>
                                    <span class="deployment-info-value" th:text="${deployment.readyReplicas}">0</span>
                                </div>
                            </div>
                            <div class="scale-form">
                                <form th:id="'scaleForm-' + ${connWithDepl.connection.id} + '-' + ${deployment.name}"
                                      th:action="@{'/deployments/' + ${connWithDepl.connection.id} + '/' + ${deployment.namespace} + '/' + ${deployment.name} + '/scale'}" 
                                      method="post">
                                    <input type="hidden" name="groupId" th:value="${group.id}">
                                    <input type="number" 
                                           name="replicas" 
                                           th:id="'scaleInput-' + ${connWithDepl.connection.id} + '-' + ${deployment.name}"
                                           th:value="${deployment.currentReplicas}"
                                           th:data-original="${deployment.currentReplicas}"
                                           th:data-connection-id="${connWithDepl.connection.id}"
                                           th:data-namespace="${connWithDepl.namespace}"
                                           th:data-deployment-name="${deployment.name}"
                                           min="0" 
                                           max="100"
                                           class="scale-input-small"
                                           onchange="markAsChangedInGroup(this)"
                                           required>
                                    <button type="submit" class="btn-save">OK</button>
                                </form>
                            </div>
                            <div class="deployment-actions">
                                <form th:action="@{'/deployments/' + ${connWithDepl.connection.id} + '/' + ${deployment.namespace} + '/' + ${deployment.name} + '/pods/delete'}" method="post">
                                    <input type="hidden" name="groupId" th:value="${group.id}">
                                    <button type="submit" class="btn-action btn-delete" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">üóëÔ∏è</button>
                                </form>
                                <form th:action="@{'/deployments/' + ${connWithDepl.connection.id} + '/' + ${deployment.namespace} + '/' + ${deployment.name} + '/pods/restart'}" method="post">
                                    <input type="hidden" name="groupId" th:value="${group.id}">
                                    <button type="submit" class="btn-action btn-restart" title="–†–µ—Å—Ç–∞—Ä—Ç">üîÑ</button>
                                </form>
                                <form th:action="@{'/deployments/' + ${connWithDepl.connection.id} + '/' + ${deployment.namespace} + '/' + ${deployment.name} + '/pods/restore'}" method="post">
                                    <input type="hidden" name="groupId" th:value="${group.id}">
                                    <button type="submit" class="btn-action btn-restore" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥—ã">‚Ü©Ô∏è</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${connWithDepl.deployments == null or connWithDepl.deployments.isEmpty()}" class="empty-state">
                    <p style="font-size: 13px;">–ù–µ—Ç deployments</p>
                </div>
            </div>
        </div>

        <div th:if="${connectionsWithDeployments == null or connectionsWithDeployments.isEmpty()}" class="empty-state">
            <h3>–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ</h3>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É</p>
        </div>
    </div>

    <script>
        function toggleSelectAllForConnection(connectionId) {
            const selectAll = document.getElementById('selectAll-' + connectionId);
            const checkboxes = document.querySelectorAll('.deployment-select[data-connection-id="' + connectionId + '"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateGlobalBatchActions();
        }

        function updateGlobalBatchActions() {
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ deployments –∏–∑ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
            const allChecked = document.querySelectorAll('.deployment-select:checked');
            const selectedCount = allChecked.length;
            const globalSelectedCount = document.getElementById('globalSelectedCount');
            const globalBatchShutdownBtn = document.getElementById('globalBatchShutdownBtn');
            const globalBatchRestartBtn = document.getElementById('globalBatchRestartBtn');
            const globalBatchRestoreBtn = document.getElementById('globalBatchRestoreBtn');
            
            if (globalSelectedCount) {
                globalSelectedCount.textContent = selectedCount;
            }
            
            if (selectedCount > 0) {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ connectionId|namespace|deploymentName
                const selectedDeployments = Array.from(allChecked).map(cb => {
                    const connectionId = cb.getAttribute('data-connection-id');
                    const namespace = cb.getAttribute('data-namespace');
                    const deploymentName = cb.value;
                    return connectionId + '|' + namespace + '|' + deploymentName;
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º
                const shutdownInput = document.getElementById('globalShutdownDeployments');
                const restartInput = document.getElementById('globalRestartDeployments');
                const restoreInput = document.getElementById('globalRestoreDeployments');
                
                if (shutdownInput) shutdownInput.value = selectedDeployments.join(',');
                if (restartInput) restartInput.value = selectedDeployments.join(',');
                if (restoreInput) restoreInput.value = selectedDeployments.join(',');
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                if (globalBatchShutdownBtn) globalBatchShutdownBtn.disabled = false;
                if (globalBatchRestartBtn) globalBatchRestartBtn.disabled = false;
                if (globalBatchRestoreBtn) globalBatchRestoreBtn.disabled = false;
            } else {
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                if (globalBatchShutdownBtn) globalBatchShutdownBtn.disabled = true;
                if (globalBatchRestartBtn) globalBatchRestartBtn.disabled = true;
                if (globalBatchRestoreBtn) globalBatchRestoreBtn.disabled = true;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const allConnectionIds = new Set();
            allChecked.forEach(cb => {
                allConnectionIds.add(cb.getAttribute('data-connection-id'));
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            document.querySelectorAll('[id^="selectAll-"]').forEach(selectAll => {
                const connectionId = selectAll.id.replace('selectAll-', '');
                const checkboxes = document.querySelectorAll('.deployment-select[data-connection-id="' + connectionId + '"]');
                if (checkboxes.length > 0) {
                    const checkedInConnection = document.querySelectorAll('.deployment-select[data-connection-id="' + connectionId + '"]:checked');
                    selectAll.checked = checkedInConnection.length === checkboxes.length;
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã
        document.addEventListener('DOMContentLoaded', function() {
            const globalShutdownForm = document.getElementById('globalBatchShutdownForm');
            const globalRestartForm = document.getElementById('globalBatchRestartForm');
            const globalRestoreForm = document.getElementById('globalBatchRestoreForm');

            if (globalShutdownForm) {
                globalShutdownForm.addEventListener('submit', function(e) {
                    const selectedDeployments = document.getElementById('globalShutdownDeployments').value;
                    if (!selectedDeployments) {
                        e.preventDefault();
                        alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã deployments –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                        return false;
                    }
                    const deployments = selectedDeployments.split(',');
                    const oldInput = document.getElementById('globalShutdownDeployments');
                    oldInput.remove();
                    deployments.forEach(deployment => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selectedDeployments';
                        input.value = deployment.trim();
                        this.appendChild(input);
                    });
                });
            }

            if (globalRestartForm) {
                globalRestartForm.addEventListener('submit', function(e) {
                    const selectedDeployments = document.getElementById('globalRestartDeployments').value;
                    if (!selectedDeployments) {
                        e.preventDefault();
                        alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã deployments –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
                        return false;
                    }
                    const deployments = selectedDeployments.split(',');
                    const oldInput = document.getElementById('globalRestartDeployments');
                    oldInput.remove();
                    deployments.forEach(deployment => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selectedDeployments';
                        input.value = deployment.trim();
                        this.appendChild(input);
                    });
                });
            }

            if (globalRestoreForm) {
                globalRestoreForm.addEventListener('submit', function(e) {
                    const selectedDeployments = document.getElementById('globalRestoreDeployments').value;
                    if (!selectedDeployments) {
                        e.preventDefault();
                        alert('–ù–µ –≤—ã–±—Ä–∞–Ω—ã deployments –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                        return false;
                    }
                    const deployments = selectedDeployments.split(',');
                    const oldInput = document.getElementById('globalRestoreDeployments');
                    oldInput.remove();
                    deployments.forEach(deployment => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selectedDeployments';
                        input.value = deployment.trim();
                        this.appendChild(input);
                    });
                });
            }
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –≥—Ä—É–ø–ø–µ
        function markAsChangedInGroup(input) {
            input.classList.add('changed');
            updateSaveAllButtonInGroup();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ" –≤ –≥—Ä—É–ø–ø–µ
        function updateSaveAllButtonInGroup() {
            const changedInputs = document.querySelectorAll('.scale-input-small.changed');
            const saveAllBtn = document.getElementById('saveAllScalingsBtn');
            if (saveAllBtn) {
                if (changedInputs.length > 0) {
                    saveAllBtn.disabled = false;
                    saveAllBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ (' + changedInputs.length + ')';
                } else {
                    saveAllBtn.disabled = true;
                    saveAllBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ';
                }
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ
        function saveAllScalingsInGroup() {
            const changedInputs = document.querySelectorAll('.scale-input-small.changed');
            if (changedInputs.length === 0) {
                alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            const scalingData = [];
            changedInputs.forEach(input => {
                const connectionId = input.getAttribute('data-connection-id');
                const namespace = input.getAttribute('data-namespace');
                const deploymentName = input.getAttribute('data-deployment-name');
                const newValue = input.value;
                const originalValue = input.getAttribute('data-original');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                if (newValue !== originalValue && connectionId && namespace && deploymentName) {
                    scalingData.push(connectionId + '|' + namespace + '|' + deploymentName + '|' + newValue);
                }
            });

            if (scalingData.length === 0) {
                alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º groupId –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∫–Ω–æ–ø–∫–∏
            const saveAllBtn = document.getElementById('saveAllScalingsBtn');
            if (!saveAllBtn) {
                alert('–û—à–∏–±–∫–∞: –∫–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const groupId = saveAllBtn.getAttribute('data-group-id');
            
            if (!groupId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –≥—Ä—É–ø–ø—ã');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/groups/' + groupId + '/batch/scale';
            
            scalingData.forEach(data => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'scalingData';
                input.value = data;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è deployments –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –≥—Ä—É–ø–ø–µ
        function filterDeploymentsInGroup() {
            const searchInput = document.getElementById('groupDeploymentSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const deploymentRows = document.querySelectorAll('.deployment-row');
            
            deploymentRows.forEach(row => {
                const deploymentNameElement = row.querySelector('.deployment-name');
                if (deploymentNameElement) {
                    const deploymentName = deploymentNameElement.textContent.toLowerCase().trim();
                    if (deploymentName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            updateGlobalBatchActions();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≥—Ä—É–ø–ø—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateSaveAllButtonInGroup();
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
            document.querySelectorAll('.scale-input-small').forEach(input => {
                const originalValue = input.value;
                input.setAttribute('data-original', originalValue);
                
                input.addEventListener('input', function() {
                    markAsChangedInGroup(this);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ "–∏–∑–º–µ–Ω–µ–Ω–æ" –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã
                const form = input.closest('form');
                if (form) {
                    form.addEventListener('submit', function() {
                        setTimeout(() => {
                            const currentInput = document.getElementById(input.id);
                            if (currentInput) {
                                currentInput.classList.remove('changed');
                                currentInput.setAttribute('data-original', currentInput.value);
                            }
                            updateSaveAllButtonInGroup();
                        }, 100);
                    });
                }
            });
        });
    </script>
</body>
</html>

